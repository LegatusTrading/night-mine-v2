#!/bin/bash
# Save all private data to timestamped backup

set -e

# Generate timestamp
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_DIR="$HOME/blockchain/midnight/data/${TIMESTAMP}_night-miner-v2"

echo "Creating backup: $BACKUP_DIR"
mkdir -p "$BACKUP_DIR"

# Save config files (*.conf, excluding .example)
if [ -d config ] && compgen -G "config/*.conf" > /dev/null; then
    echo "Backing up config files..."
    mkdir -p "$BACKUP_DIR/config"
    cp config/*.conf "$BACKUP_DIR/config/" 2>/dev/null || true
fi

# Save data directory (backups)
if [ -d data ]; then
    echo "Backing up data directory..."
    cp -r data "$BACKUP_DIR/"
fi

# Save hd-wallets directory (mnemonic and keys)
if [ -d hd-wallets ]; then
    echo "Backing up hd-wallets directory..."
    cp -r hd-wallets "$BACKUP_DIR/"
fi

# Save wallets.json if exists
if [ -f wallets.json ]; then
    echo "Backing up wallets.json..."
    cp wallets.json "$BACKUP_DIR/"
fi

# Save other private runtime files if they exist
for file in balances.json challenges.json developer_addresses.json solutions.csv; do
    if [ -f "$file" ]; then
        echo "Backing up $file..."
        cp "$file" "$BACKUP_DIR/"
    fi
done

# Save logs
if [ -f miner.log ]; then
    echo "Backing up miner.log..."
    cp miner.log "$BACKUP_DIR/"
fi

# Create a manifest of what was saved
echo "Creating backup manifest..."
cat > "$BACKUP_DIR/BACKUP_MANIFEST.txt" <<EOF
Midnight Miner v2 - Private Data Backup
========================================
Backup Date: $(date)
Timestamp: $TIMESTAMP
Source: $(pwd)

Contents:
EOF

find "$BACKUP_DIR" -type f | sed "s|$BACKUP_DIR/||" | sort >> "$BACKUP_DIR/BACKUP_MANIFEST.txt"

echo ""
echo "âœ“ Backup complete!"
echo "Location: $BACKUP_DIR"
echo ""
echo "Files backed up:"
cat "$BACKUP_DIR/BACKUP_MANIFEST.txt" | grep -v "^Midnight" | grep -v "^===" | grep -v "^Backup Date" | grep -v "^Timestamp" | grep -v "^Source" | grep -v "^Contents" | grep -v "^$"
